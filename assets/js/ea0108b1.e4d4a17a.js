"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3871],{51:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"API/bundle","title":"Bundle Processing","description":"Couchbase FHIR CE supports FHIR Bundles to perform multiple operations in a single request.","source":"@site/docs/API/bundle.mdx","sourceDirName":"API","slug":"/API/bundle","permalink":"/docs/API/bundle","draft":false,"unlisted":false,"editUrl":"https://github.com/couchbaselabs/couchbase-fhir-ce-docs/tree/master/docs/API/bundle.mdx","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"sidebar_position":9,"title":"Bundle Processing"},"sidebar":"tutorialSidebar","previous":{"title":"DELETE Resource","permalink":"/docs/API/delete"},"next":{"title":"Search - Basic","permalink":"/docs/API/search-basic"}}');var r=s(4848),t=s(8453);const l=s.p+"assets/images/bundle-2e9d59c5a2058f0023f31dbaf55c177d.png",o={sidebar_position:9,title:"Bundle Processing"},a="Bundle \u2014 Batch & Transaction",c={},d=[{value:"Example",id:"example",level:2},{value:"JSON Body",id:"json-body",level:4},{value:"Response - 200 OK",id:"response---200-ok",level:4},{value:"Bundle Types",id:"bundle-types",level:2},{value:"type: &quot;transaction&quot;",id:"type-transaction",level:3},{value:"Response: type:",id:"response-type",level:4},{value:"type: &quot;batch&quot;",id:"type-batch",level:3},{value:"Response: type:",id:"response-type-1",level:4},{value:"Entry Anatomy",id:"entry-anatomy",level:3},{value:"URN / fullUrl resolution",id:"urn--fullurl-resolution",level:3},{value:"Processing Model",id:"processing-model",level:2},{value:"Versioning &amp; audit",id:"versioning--audit",level:2},{value:"Commit / rollback",id:"commit--rollback",level:2},{value:"Isolation &amp; consistency",id:"isolation--consistency",level:2},{value:"Response Shape",id:"response-shape",level:2},{value:"Our sample shows:",id:"our-sample-shows",level:3},{value:"Conditionals inside Bundles",id:"conditionals-inside-bundles",level:2},{value:"Validation &amp; Profiles",id:"validation--profiles",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Summary",id:"summary",level:2}];function h(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"bundle--batch--transaction",children:"Bundle \u2014 Batch & Transaction"})}),"\n",(0,r.jsx)(n.p,{children:"Couchbase FHIR CE supports FHIR Bundles to perform multiple operations in a single request.\nEndpoint (note: no resource type in the path):"}),"\n",(0,r.jsx)(n.h2,{id:"example",children:"Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"POST /fhir/<bucket>/\ne.g. POST http://localhost/fhir/acme/\n"})}),"\n",(0,r.jsx)("img",{src:l,alt:"ImgBundle"}),"\n",(0,r.jsx)(n.h4,{id:"json-body",children:"JSON Body"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "resourceType": "Bundle",\n  "type": "transaction",\n  "entry": [\n    {\n      "fullUrl": "urn:uuid:3da658f0-76ae-4ddd-94ce-4cdbb12a1e8e",\n      "resource": {\n        "resourceType": "Patient",\n        "id": "3da658f0-76ae-4ddd-94ce-4cdbb12a1e8e",\n        "identifier": [\n          {\n            "system": "http://hospital.smarthealthit.org",\n            "value": "MRN001"\n          }\n        ],\n        "name": [\n          {\n            "use": "official",\n            "family": "Doe",\n            "given": ["Jane"]\n          }\n        ],\n        "gender": "female",\n        "birthDate": "1970-12-01"\n      },\n      "request": {\n        "method": "POST",\n        "url": "Patient"\n      }\n    },\n    {\n      "fullUrl": "urn:uuid:ad8085ce-fbf7-442b-99e5-f9f02e7dcd92",\n      "resource": {\n        "resourceType": "Observation",\n        "status": "final",\n        "category": [\n          {\n            "coding": [\n              {\n                "system": "http://terminology.hl7.org/CodeSystem/observation-category",\n                "code": "vital-signs",\n                "display": "Vital Signs"\n              }\n            ]\n          }\n        ],\n        "code": {\n          "coding": [\n            {\n              "system": "http://loinc.org",\n              "code": "85354-9",\n              "display": "Blood pressure panel with all children optional"\n            }\n          ]\n        },\n        "subject": {\n          "reference": "urn:uuid:3da658f0-76ae-4ddd-94ce-4cdbb12a1e8e"\n        },\n        "effectiveDateTime": "2023-06-01T12:00:00Z",\n        "component": [\n          {\n            "code": {\n              "coding": [\n                {\n                  "system": "http://loinc.org",\n                  "code": "8480-6",\n                  "display": "Systolic blood pressure"\n                }\n              ]\n            },\n            "valueQuantity": {\n              "value": 120,\n              "unit": "mmHg"\n            }\n          },\n          {\n            "code": {\n              "coding": [\n                {\n                  "system": "http://loinc.org",\n                  "code": "8462-4",\n                  "display": "Diastolic blood pressure"\n                }\n              ]\n            },\n            "valueQuantity": {\n              "value": 80,\n              "unit": "mmHg"\n            }\n          }\n        ]\n      },\n      "request": {\n        "method": "POST",\n        "url": "Observation"\n      }\n    }\n  ]\n}\n'})}),"\n",(0,r.jsx)(n.h4,{id:"response---200-ok",children:"Response - 200 OK"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "resourceType": "Bundle",\n  "id": "5ab72487-9469-4240-a3a0-b418b1b1e7c3",\n  "meta": {\n    "lastUpdated": "2025-10-09T19:54:36.095+00:00"\n  },\n  "type": "transaction-response",\n  "timestamp": "2025-10-09T19:54:36.095+00:00",\n  "link": [\n    {\n      "relation": "self",\n      "url": "http://localhost/fhir/acme/"\n    }\n  ],\n  "entry": [\n    {\n      "resource": {\n        "resourceType": "Patient",\n        "id": "8c350e25-1640-421b-a1e1-e6d077873728",\n        "meta": {\n          "versionId": "1",\n          "lastUpdated": "2025-10-09T19:54:35.974+00:00",\n          "tag": [\n            {\n              "system": "http://couchbase.fhir.com/fhir/custom-tags",\n              "code": "created-by",\n              "display": "user:anonymous"\n            }\n          ]\n        },\n        "identifier": [\n          {\n            "system": "http://hospital.smarthealthit.org",\n            "value": "MRN001"\n          }\n        ],\n        "name": [\n          {\n            "use": "official",\n            "family": "Doe",\n            "given": ["Jane"]\n          }\n        ],\n        "gender": "female",\n        "birthDate": "1970-12-01"\n      },\n      "response": {\n        "status": "201 Created",\n        "location": "Patient/8c350e25-1640-421b-a1e1-e6d077873728"\n      }\n    },\n    {\n      "resource": {\n        "resourceType": "Observation",\n        "id": "e00a7f2e-1a42-446b-ba5a-9f412afc4fe2",\n        "meta": {\n          "versionId": "1",\n          "lastUpdated": "2025-10-09T19:54:36.050+00:00",\n          "tag": [\n            {\n              "system": "http://couchbase.fhir.com/fhir/custom-tags",\n              "code": "created-by",\n              "display": "user:anonymous"\n            }\n          ]\n        },\n        "status": "final",\n        "category": [\n          {\n            "coding": [\n              {\n                "system": "http://terminology.hl7.org/CodeSystem/observation-category",\n                "code": "vital-signs",\n                "display": "Vital Signs"\n              }\n            ]\n          }\n        ],\n        "code": {\n          "coding": [\n            {\n              "system": "http://loinc.org",\n              "code": "85354-9",\n              "display": "Blood pressure panel with all children optional"\n            }\n          ]\n        },\n        "subject": {\n          "reference": "Patient/8c350e25-1640-421b-a1e1-e6d077873728"\n        },\n        "effectiveDateTime": "2023-06-01T12:00:00Z",\n        "component": [\n          {\n            "code": {\n              "coding": [\n                {\n                  "system": "http://loinc.org",\n                  "code": "8480-6",\n                  "display": "Systolic blood pressure"\n                }\n              ]\n            },\n            "valueQuantity": {\n              "value": 120,\n              "unit": "mmHg"\n            }\n          },\n          {\n            "code": {\n              "coding": [\n                {\n                  "system": "http://loinc.org",\n                  "code": "8462-4",\n                  "display": "Diastolic blood pressure"\n                }\n              ]\n            },\n            "valueQuantity": {\n              "value": 80,\n              "unit": "mmHg"\n            }\n          }\n        ]\n      },\n      "response": {\n        "status": "201 Created",\n        "location": "Observation/e00a7f2e-1a42-446b-ba5a-9f412afc4fe2"\n      }\n    }\n  ]\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"bundle-types",children:"Bundle Types"}),"\n",(0,r.jsx)(n.h3,{id:"type-transaction",children:'type: "transaction"'}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Atomic, all-or-nothing. The server processes the entries as a single unit:"}),"\n",(0,r.jsx)(n.li,{children:"If all succeed \u2192 commit."}),"\n",(0,r.jsx)(n.li,{children:"If any fails \u2192 none are applied; the response includes the failure."}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"response-type",children:"Response: type:"}),"\n",(0,r.jsx)(n.p,{children:'"transaction-response" with one entry.response per input entry.'}),"\n",(0,r.jsx)(n.h3,{id:"type-batch",children:'type: "batch"'}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Non-atomic. Entries are executed independently; some may succeed while others fail."}),"\n",(0,r.jsx)(n.li,{children:"Order is server-defined (no cross-entry guarantees)."}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"response-type-1",children:"Response: type:"}),"\n",(0,r.jsx)(n.p,{children:'"batch-response" with one entry.response per input entry.'}),"\n",(0,r.jsx)(n.h3,{id:"entry-anatomy",children:"Entry Anatomy"}),"\n",(0,r.jsx)(n.p,{children:"Each entry typically has:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"fullUrl"}),": a temporary identifier for this entry\u2019s resource.\nCommonly a URN such as urn:uuid",":guid"," used to link entries together before real IDs exist."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"resource"}),": the FHIR resource payload (for methods that send a body)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"request"}),": the operation to perform:"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"method"}),": POST, PUT, PATCH, DELETE, or GET"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"url"}),": relative interaction URL such as Patient, Patient/123, Observation?code=\u2026, etc."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"urn--fullurl-resolution",children:"URN / fullUrl resolution"}),"\n",(0,r.jsx)(n.p,{children:"Within the same bundle, you can reference another entry\u2019s fullUrl.\nDuring processing the server:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Creates the resource (assigning server ID for POST)."}),"\n",(0,r.jsx)(n.li,{children:"Builds a mapping from fullUrl \u2192 the final canonical reference (e.g., Patient/8c350e25-\u2026)."}),"\n",(0,r.jsx)(n.li,{children:"Rewrites internal references to canonical form."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"In our example, the Observation\u2019s subject.reference changes from\nurn:uuid:3da6\u2026 \u2192 Patient/8c350e25-1640-421b-a1e1-e6d077873728."}),"\n",(0,r.jsx)(n.h2,{id:"processing-model",children:"Processing Model"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"For transaction bundles, Couchbase FHIR CE executes the entire bundle inside a single ACID transaction over Couchbase:"}),"\n",(0,r.jsx)(n.li,{children:"Collect & validate entries (FHIR R4 rules, plus US Core if enabled for the bucket)."}),"\n",(0,r.jsxs)(n.li,{children:["If validation:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Strict"})," \u2192 any violation aborts the transaction."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Lenient"})," \u2192 warnings logged; proceed."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Disabled"})," \u2192 skip validation."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Resolve dependencies using fullUrl mapping and any conditional URLs (e.g., PUT Patient?identifier=\u2026)."}),"\n",(0,r.jsxs)(n.li,{children:["Apply each request in a safe order (e.g., create Patient before Observation that references it).","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"POST"}),": server assigns a new UUID id."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"PUT"}),": preserves/sets the ID from the URL; creates or updates."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"PATCH"}),": applies JSON Patch (RFC 6902)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"DELETE"}),": soft-deletes (tombstone)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"GET"}),": allowed in bundles; returns the matched resource in the response entry."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"versioning--audit",children:"Versioning & audit"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"meta.versionId increments per write."}),"\n",(0,r.jsx)(n.li,{children:"meta.lastUpdated set by server."}),"\n",(0,r.jsx)(n.li,{children:"meta.tag set (created-by / updated-by)."}),"\n",(0,r.jsx)(n.li,{children:"Prior versions copied to Resources.Versions."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"commit--rollback",children:"Commit / rollback"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Transaction bundles: either everything commits or everything rolls back."}),"\n",(0,r.jsx)(n.li,{children:"Batch bundles: no overall transaction; each entry stands alone."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"isolation--consistency",children:"Isolation & consistency"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Transaction bundles run with ACID semantics across the participating KV/N1QL operations."}),"\n",(0,r.jsx)(n.li,{children:"Practical effect: readers won\u2019t see partial results; writers see a consistent snapshot of documents involved."}),"\n",(0,r.jsx)(n.li,{children:"No READ-UNCOMMITTED."}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{title:"FTS",type:"info",children:(0,r.jsx)(n.p,{children:"FTS itself is not transactional; searches reflect the committed state once the transaction completes and the index refreshes."})}),"\n",(0,r.jsx)(n.h2,{id:"response-shape",children:"Response Shape"}),"\n",(0,r.jsx)(n.p,{children:"Top-level Bundle with:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'type: "transaction-response" or "batch-response"'}),"\n",(0,r.jsx)(n.li,{children:"entry[]: one per input, each with:"}),"\n",(0,r.jsx)(n.li,{children:"response.status (e.g., 201 Created, 200 OK, 204 No Content, 404 Not Found, 412 Precondition Failed)"}),"\n",(0,r.jsx)(n.li,{children:"response.location (canonical location for created/updated resources)"}),"\n",(0,r.jsx)(n.li,{children:"Optional resource (when Prefer: return=representation or when the interaction returns a body, e.g., GET)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"our-sample-shows",children:"Our sample shows:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Patient created \u2192 201 Created, location Patient/id"}),"\n",(0,r.jsx)(n.li,{children:"Observation created \u2192 201 Created, with subject rewritten to the new Patient ID"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"conditionals-inside-bundles",children:"Conditionals inside Bundles"}),"\n",(0,r.jsx)(n.p,{children:"You can use conditional interactions within entries:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Conditional PUT: PUT Patient?identifier=system|value","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"1 match \u2192 replace; 0 \u2192 create; >1 \u2192 412"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Conditional PATCH: PATCH Observation?identifier=\u2026","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"1 match \u2192 patch; 0 \u2192 404; >1 \u2192 412"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Conditional DELETE / READ similarly follow FHIR rules.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The server resolves conditionals as part of the transaction, so either all cross-references are fixed and applied, or none are."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"validation--profiles",children:"Validation & Profiles"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Base FHIR R4 validation always available."}),"\n",(0,r.jsx)(n.li,{children:"If the bucket enables US Core 6.1.0, profile rules and ValueSet bindings are enforced per your Strict / Lenient / Disabled setting."}),"\n",(0,r.jsx)(n.li,{children:"Failures in Strict abort a transaction bundle."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Prefer transaction when creating graph-connected resources (Patient + related Observations), so references are resolved atomically."}),"\n",(0,r.jsx)(n.li,{children:'Use fullUrl: "urn:uuid:..." for intra-bundle linking; avoid guessing IDs.'}),"\n",(0,r.jsx)(n.li,{children:"For upserts, prefer conditional PUT with a unique identifier rather than name."}),"\n",(0,r.jsx)(n.li,{children:"Keep bundles reasonable in size for performance (e.g., tens to low hundreds of entries)."}),"\n",(0,r.jsx)(n.li,{children:"For responses, add header Prefer: return=representation if you want the full created/updated resources echoed in each entry.resource."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Batch = independent operations, non-atomic."}),"\n",(0,r.jsx)(n.li,{children:"Transaction = atomic ACID unit; reference rewriting, versioning, and validation all happen together."}),"\n",(0,r.jsx)(n.li,{children:"fullUrl + URNs let you build self-contained graphs that the server resolves to canonical references in one step."}),"\n",(0,r.jsx)(n.li,{children:"The endpoint is the bucket root (/fhir/bucket/), not a resource type."}),"\n",(0,r.jsx)(n.li,{children:"Fully aligned with FHIR R4 semantics; US Core rules apply when enabled."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>o});var i=s(6540);const r={},t=i.createContext(r);function l(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);